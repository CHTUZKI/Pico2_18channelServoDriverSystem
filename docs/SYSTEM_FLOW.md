# 系统流程图 - 从指令到PWM输出

## 完整数据流程

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          上位机 (Python/PyQt5)                           │
│                                                                          │
│  ┌──────────────┐      ┌──────────────┐      ┌──────────────┐         │
│  │ 时间轴编辑器 │ →→→ │ ServoCommander│ →→→ │  SerialComm  │         │
│  │(GUI拖拽编辑) │      │  (流式命令器)  │      │  (串口通信)  │         │
│  └──────────────┘      └──────────────┘      └──────┬───────┘         │
│                                                       │                  │
│                         生成运动块序列                │                  │
│                         (时间戳+参数)                 │ USB CDC          │
└───────────────────────────────────────────────────────┼──────────────────┘
                                                        │
                                                        ↓
┌─────────────────────────────────────────────────────────────────────────┐
│                    Pico2 Core 1 (USB专用核心)                            │
│                                                                          │
│  ┌──────────────┐      ┌──────────────┐      ┌──────────────┐         │
│  │   USB CDC    │ →→→ │  USB Bridge  │ →→→ │  Ring Buffer │         │
│  │   (TinyUSB)  │      │(环形缓冲区Tx)│      │  (Core0←1)   │         │
│  └──────────────┘      └──────────────┘      └──────┬───────┘         │
│                                                       │                  │
└───────────────────────────────────────────────────────┼──────────────────┘
                                                        │
                                                        ↓
┌─────────────────────────────────────────────────────────────────────────┐
│                 Pico2 Core 0 (业务逻辑核心) - QP/C框架                   │
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │              AO_Communication (通信主动对象)                     │   │
│  │                                                                  │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────┐ │   │
│  │  │ USB Bridge Rx│→→│ Protocol解析 │→→│  Command Dispatcher  │ │   │
│  │  │ (环形缓冲读) │  │(CRC16校验)   │  │   (命令分发器)        │ │   │
│  │  └──────────────┘  └──────────────┘  └──────────┬───────────┘ │   │
│  │                                                   │              │   │
│  └───────────────────────────────────────────────────┼──────────────┘   │
│                                                      │                  │
│                        ┌─────────────────────────────┼──────────────┐  │
│                        │                             ↓              │  │
│                        │  ┌──────────────────────────────────────┐ │  │
│                        │  │      根据命令类型分发：               │ │  │
│                        │  │  ┌────────────────────────────────┐  │ │  │
│                        │  │  │ CMD_ADD_MOTION_BLOCK (0x40)    │  │ │  │
│                        │  │  │ ↓                              │  │ │  │
│                        │  │  │ cmd_add_motion_block()         │  │ │  │
│                        │  │  │ ↓                              │  │ │  │
│                        │  │  │ motion_scheduler_add_block()   │  │ │  │
│                        │  │  └────────────────────────────────┘  │ │  │
│                        │  │                                      │ │  │
│                        │  │  ┌────────────────────────────────┐  │ │  │
│                        │  │  │ CMD_START_MOTION (0x41)        │  │ │  │
│                        │  │  │ ↓                              │  │ │  │
│                        │  │  │ cmd_start_motion()             │  │ │  │
│                        │  │  │ ↓                              │  │ │  │
│                        │  │  │ motion_scheduler_start()       │  │ │  │
│                        │  │  └────────────────────────────────┘  │ │  │
│                        │  └──────────────────────────────────────┘ │  │
│                        └───────────────────────────────────────────┘  │
│                                                      │                  │
│                                                      ↓                  │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                  Motion Scheduler (运动调度器)                   │   │
│  │                                                                  │   │
│  │  ┌──────────────────────────────────────────────────────────┐  │   │
│  │  │           Motion Buffer (32条指令FIFO队列)               │  │   │
│  │  │                                                          │  │   │
│  │  │  [0] {ts=0ms,    S1, 90°,  v=30, a=60}                  │  │   │
│  │  │  [1] {ts=1000ms, S1, 180°, v=30, a=60}                  │  │   │
│  │  │  [2] {ts=2000ms, S2, 45°,  v=50, a=100}                 │  │   │
│  │  │  [3] ...                                                │  │   │
│  │  │                                                          │  │   │
│  │  └──────────────────────────────────────────────────────────┘  │   │
│  │                           │                                     │   │
│  │              每20ms检查一次 (INTERP_TICK_SIG)                   │   │
│  │                           ↓                                     │   │
│  │  ┌──────────────────────────────────────────────────────────┐  │   │
│  │  │  motion_scheduler_update()                              │  │   │
│  │  │                                                          │  │   │
│  │  │  1. 获取当前时间                                          │  │   │
│  │  │  2. peek下一条指令                                        │  │   │
│  │  │  3. 时间戳匹配？                                          │  │   │
│  │  │     ├─ 否 → 等待                                         │  │   │
│  │  │     └─ 是 → 执行回调                                     │  │   │
│  │  │             motion_execute_trapezoid_callback()         │  │   │
│  │  │             ↓                                            │  │   │
│  │  │             AO_Motion_set_trapezoid()                   │  │   │
│  │  │             ↓                                            │  │   │
│  │  │             POST(MOTION_START_SIG)                      │  │   │
│  │  │                                                          │  │   │
│  │  └──────────────────────────────────────────────────────────┘  │   │
│  └─────────────────────────────┬────────────────────────────────────┘   │
│                                │                                        │
│                                ↓                                        │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                AO_Motion (运动主动对象)                          │   │
│  │                                                                  │   │
│  │  ┌──────────────────────────────────────────────────────────┐  │   │
│  │  │              QP/C状态机 (Event-Driven)                   │  │   │
│  │  │                                                          │  │   │
│  │  │   IDLE状态                                               │  │   │
│  │  │     │                                                    │  │   │
│  │  │     ├─ INTERP_TICK_SIG → motion_scheduler_update()     │  │   │
│  │  │     │                                                    │  │   │
│  │  │     └─ MOTION_START_SIG → 转换到MOVING状态              │  │   │
│  │  │                              │                           │  │   │
│  │  │   MOVING状态                 │                           │  │   │
│  │  │     │◄──────────────────────┘                           │  │   │
│  │  │     │                                                    │  │   │
│  │  │     └─ INTERP_TICK_SIG → interpolator_update()         │  │   │
│  │  │                              ↓                           │  │   │
│  │  └──────────────────────────────┼───────────────────────────┘  │   │
│  └─────────────────────────────────┼──────────────────────────────┘   │
│                                    │                                   │
└────────────────────────────────────┼───────────────────────────────────┘
                                     │
                                     ↓
┌─────────────────────────────────────────────────────────────────────────┐
│                      Interpolation (插值计算层)                          │
│                                                                          │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │         interpolator_update() - 每20ms调用一次                    │  │
│  │                                                                   │  │
│  │   根据插值类型选择算法：                                           │  │
│  │                                                                   │  │
│  │   ┌─────────────────────────────────────────────────────────┐   │  │
│  │   │  INTERP_TYPE_TRAPEZOID (梯形速度曲线)                    │   │  │
│  │   │                                                         │   │  │
│  │   │  interpolator_update_trapezoid():                      │   │  │
│  │   │                                                         │   │  │
│  │   │  1. 计算三段时间                                         │   │  │
│  │   │     ├─ t_accel  = v / a                                │   │  │
│  │   │     ├─ t_const  = (distance - accel_dist - decel_dist)/v│   │  │
│  │   │     └─ t_decel  = v / d                                │   │  │
│  │   │                                                         │   │  │
│  │   │  2. 根据当前时间判断所处阶段                              │   │  │
│  │   │     ├─ 加速段：pos = 0.5 * a * t²                      │   │  │
│  │   │     ├─ 匀速段：pos = accel_dist + v * (t - t_accel)   │   │  │
│  │   │     └─ 减速段：pos = total - 0.5 * d * (t_total - t)² │   │  │
│  │   │                                                         │   │  │
│  │   │  3. 返回当前角度                                         │   │  │
│  │   │     current_pos = start_pos + Δpos                     │   │  │
│  │   │                                                         │   │  │
│  │   └─────────────────────────────────────────────────────────┘   │  │
│  │                                                                   │  │
│  │   ┌─────────────────────────────────────────────────────────┐   │  │
│  │   │  INTERP_TYPE_LINEAR (线性插值)                           │   │  │
│  │   │                                                         │   │  │
│  │   │  pos = start + (end - start) * (elapsed / duration)    │   │  │
│  │   │                                                         │   │  │
│  │   └─────────────────────────────────────────────────────────┘   │  │
│  │                                                                   │  │
│  │   ┌─────────────────────────────────────────────────────────┐   │  │
│  │   │  INTERP_TYPE_S_CURVE (S曲线插值)                         │   │  │
│  │   │                                                         │   │  │
│  │   │  ratio = t² * (3 - 2t)  (smoothstep函数)              │   │  │
│  │   │  pos = start + (end - start) * ratio                   │   │  │
│  │   │                                                         │   │  │
│  │   └─────────────────────────────────────────────────────────┘   │  │
│  │                                                                   │  │
│  └───────────────────────────────┬───────────────────────────────────┘  │
└─────────────────────────────────┼──────────────────────────────────────┘
                                  │
                                  ↓ 返回当前角度 (float)
┌─────────────────────────────────────────────────────────────────────────┐
│                     Servo Control (舵机控制层)                           │
│                                                                          │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │                  servo_set_angle(id, angle)                       │  │
│  │                                                                   │  │
│  │  1. 检查角度范围（0-180度）                                        │  │
│  │     ├─ 超限 → 返回错误                                            │  │
│  │     └─ 合法 → 继续                                                │  │
│  │                                                                   │  │
│  │  2. 角度转脉宽                                                     │  │
│  │     servo_angle_to_pulse(id, angle)                              │  │
│  │     ↓                                                             │  │
│  │     pulse = min_pulse + (angle/180) * (max_pulse - min_pulse)   │  │
│  │           + offset                                               │  │
│  │     ↓                                                             │  │
│  │     应用校准参数（反转、偏移）                                       │  │
│  │     ↓                                                             │  │
│  │     pulse_us = 500 ~ 2500μs                                      │  │
│  │                                                                   │  │
│  │  3. 更新舵机状态                                                   │  │
│  │     g_servos[id].current_angle = angle                           │  │
│  │     g_servos[id].current_pulse_us = pulse_us                     │  │
│  │                                                                   │  │
│  └───────────────────────────────┬───────────────────────────────────┘  │
└─────────────────────────────────┼──────────────────────────────────────┘
                                  │
                                  ↓ pulse_us
┌─────────────────────────────────────────────────────────────────────────┐
│                       PWM Driver (PWM驱动层)                             │
│                                                                          │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │                  pwm_set_pulse(id, pulse_us)                      │  │
│  │                                                                   │  │
│  │  1. 计算PWM占空比                                                  │  │
│  │     周期 = 20ms (50Hz)                                            │  │
│  │     占空比 = pulse_us / 20000                                     │  │
│  │             = 500~2500 / 20000                                   │  │
│  │             = 2.5% ~ 12.5%                                       │  │
│  │                                                                   │  │
│  │  2. 转换为计数值                                                   │  │
│  │     PWM时钟 = 2MHz                                                │  │
│  │     周期计数 = 2MHz * 20ms = 40000                                │  │
│  │     高电平计数 = pulse_us * 2 (1μs = 2个计数)                      │  │
│  │                                                                   │  │
│  │  3. 写入硬件寄存器                                                 │  │
│  │     pwm_set_chan_level(slice, channel, level)                   │  │
│  │     ↓                                                             │  │
│  │     RP2350硬件PWM自动生成波形                                      │  │
│  │                                                                   │  │
│  └───────────────────────────────┬───────────────────────────────────┘  │
└─────────────────────────────────┼──────────────────────────────────────┘
                                  │
                                  ↓ 硬件PWM信号
┌─────────────────────────────────────────────────────────────────────────┐
│                          物理输出 (GPIO)                                 │
│                                                                          │
│   GPIO 0-17 输出PWM波形                                                  │
│                                                                          │
│   ┌────┐              ┌────┐              ┌────┐                       │
│   │    │              │    │              │    │                       │
│   │    │              │    │              │    │                       │
│ ──┘    └──────────────┘    └──────────────┘    └──────────            │
│   │←500~2500μs→│                                                        │
│   │←────────── 20ms (50Hz) ─────────→│                                 │
│                                                                          │
│   → 舵机接收并转动到指定角度                                              │
│                                                                          │
└──────────────────────────────────────────────────────────────────────────┘
```

## 关键流程总结

1. **上位机** → 时间轴编辑 → 流式上传运动块
2. **Pico Core1** → USB接收 → 环形缓冲区传递
3. **Pico Core0** → 协议解析 → 命令分发 → 运动缓冲区
4. **调度器** → 时间戳匹配 → 触发执行
5. **状态机** → 状态转换 → 插值计算
6. **插值器** → 梯形曲线 → 实时角度
7. **舵机控制** → 角度转脉宽 → PWM驱动
8. **GPIO输出** → 舵机转动

