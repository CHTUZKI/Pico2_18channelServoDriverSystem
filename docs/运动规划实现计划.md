# è¿åŠ¨è§„åˆ’åŠŸèƒ½å®ç°è®¡åˆ’

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

ä¸º18é€šé“èˆµæœºé©±åŠ¨ç³»ç»Ÿå®ç°ï¼š
1. **æ¢¯å½¢é€Ÿåº¦æ›²çº¿** - æ”¯æŒé€Ÿåº¦å’ŒåŠ é€Ÿåº¦æ§åˆ¶
2. **å¤šç‚¹è½¨è¿¹è§„åˆ’** - æ”¯æŒæœ€å¤š50ä¸ªè·¯å¾„ç‚¹

## ğŸ¯ åŠŸèƒ½ç›®æ ‡

### 1. æ¢¯å½¢é€Ÿåº¦æ›²çº¿
- âœ… æ”¯æŒç‹¬ç«‹çš„é€Ÿåº¦å‚æ•°ï¼ˆåº¦/ç§’ï¼‰
- âœ… æ”¯æŒç‹¬ç«‹çš„åŠ é€Ÿåº¦å‚æ•°ï¼ˆåº¦/ç§’Â²ï¼‰
- âœ… è‡ªåŠ¨è®¡ç®—è¿åŠ¨æ—¶é—´
- âœ… 3é˜¶æ®µè¿åŠ¨ï¼šåŠ é€Ÿ â†’ åŒ€é€Ÿ â†’ å‡é€Ÿ
- âœ… é€Ÿåº¦é™åˆ¶å’Œå®‰å…¨æ£€æŸ¥

### 2. å¤šç‚¹è½¨è¿¹è§„åˆ’
- âœ… æ”¯æŒæœ€å¤š50ä¸ªè·¯å¾„ç‚¹
- âœ… è½¨è¿¹é˜Ÿåˆ—ç®¡ç†ï¼ˆæ·»åŠ ã€åˆ é™¤ã€æ¸…ç©ºï¼‰
- âœ… è‡ªåŠ¨ç‚¹åˆ°ç‚¹å¹³æ»‘è¿‡æ¸¡
- âœ… è½¨è¿¹é¢„è§ˆå’Œæ‰§è¡Œæ§åˆ¶
- âœ… æ”¯æŒå¾ªç¯æ’­æ”¾

---

## ğŸ“ é˜¶æ®µä¸€ï¼šæ•°æ®ç»“æ„è®¾è®¡

### 1.1 è¿åŠ¨å‚æ•°ç»“æ„
```c
// è¿åŠ¨å‚æ•°ï¼ˆæ›¿ä»£åŸæ¥çš„durationï¼‰
typedef struct {
    float max_velocity;      // æœ€å¤§é€Ÿåº¦ (åº¦/ç§’)
    float acceleration;      // åŠ é€Ÿåº¦ (åº¦/ç§’Â²)
    float deceleration;      // å‡é€Ÿåº¦ (åº¦/ç§’Â²)
    interp_type_t curve;     // æ›²çº¿ç±»å‹
} motion_params_t;
```

### 1.2 è½¨è¿¹ç‚¹ç»“æ„
```c
#define MAX_TRAJECTORY_POINTS 50  // æœ€å¤š50ä¸ªç‚¹

// å•ä¸ªè½¨è¿¹ç‚¹
typedef struct {
    float position;          // ç›®æ ‡ä½ç½® (åº¦)
    motion_params_t params;  // è¿åŠ¨å‚æ•°
    uint32_t dwell_time_ms;  // åˆ°è¾¾ååœç•™æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
} trajectory_point_t;

// è½¨è¿¹é˜Ÿåˆ—
typedef struct {
    trajectory_point_t points[MAX_TRAJECTORY_POINTS];
    uint8_t count;           // å½“å‰ç‚¹æ•°
    uint8_t current_index;   // å½“å‰æ‰§è¡Œåˆ°ç¬¬å‡ ä¸ªç‚¹
    bool loop;               // æ˜¯å¦å¾ªç¯æ‰§è¡Œ
    bool running;            // æ˜¯å¦æ­£åœ¨æ‰§è¡Œ
} trajectory_queue_t;
```

### 1.3 æ‰©å±•æ’å€¼å™¨ç»“æ„
```c
typedef struct {
    // åŸæœ‰å­—æ®µä¿æŒ
    float start_pos;
    float target_pos;
    float current_pos;
    // ... å…¶ä»–å­—æ®µ ...
    
    // æ–°å¢ï¼šæ¢¯å½¢é€Ÿåº¦æ›²çº¿å‚æ•°
    motion_params_t motion_params;
    
    // æ–°å¢ï¼šæ¢¯å½¢é€Ÿåº¦æ›²çº¿çŠ¶æ€
    float t_accel;           // åŠ é€Ÿé˜¶æ®µæ—¶é—´
    float t_const;           // åŒ€é€Ÿé˜¶æ®µæ—¶é—´
    float t_decel;           // å‡é€Ÿé˜¶æ®µæ—¶é—´
    float v_max_actual;      // å®é™…æœ€å¤§é€Ÿåº¦
    
    // æ–°å¢ï¼šè½¨è¿¹é˜Ÿåˆ—
    trajectory_queue_t* trajectory;  // æŒ‡å‘è½¨è¿¹é˜Ÿåˆ—ï¼ˆå¦‚æœæœ‰ï¼‰
} interpolator_t;
```

**å†…å­˜å ç”¨ä¼°ç®—**ï¼š
- `motion_params_t`: 16å­—èŠ‚
- `trajectory_point_t`: 24å­—èŠ‚
- `trajectory_queue_t`: 50ç‚¹ Ã— 24å­—èŠ‚ + å¼€é”€ = ~1.2KB
- 18ä¸ªè½´çš„æ€»å¢åŠ : ~22KB (RP2350æœ‰264KB SRAMï¼Œå®Œå…¨å¤Ÿç”¨)

---

## âš™ï¸ é˜¶æ®µäºŒï¼šæ¢¯å½¢é€Ÿåº¦æ›²çº¿ç®—æ³•

### 2.1 è¿åŠ¨è§„åˆ’è®¡ç®—
```
è¾“å…¥ï¼š
- start_pos: èµ·å§‹ä½ç½®
- target_pos: ç›®æ ‡ä½ç½®
- max_velocity: æœ€å¤§é€Ÿåº¦
- acceleration: åŠ é€Ÿåº¦
- deceleration: å‡é€Ÿåº¦

è®¡ç®—æ­¥éª¤ï¼š
1. è®¡ç®—ç§»åŠ¨è·ç¦»: distance = |target_pos - start_pos|
2. è®¡ç®—åŠ é€Ÿ/å‡é€Ÿè·ç¦»: 
   - d_accel = v_maxÂ² / (2 Ã— a)
   - d_decel = v_maxÂ² / (2 Ã— d)
3. åˆ¤æ–­èƒ½å¦è¾¾åˆ°æœ€å¤§é€Ÿåº¦ï¼š
   - å¦‚æœ d_accel + d_decel > distance: ä¸‰è§’å½¢é€Ÿåº¦æ›²çº¿
   - å¦åˆ™: æ ‡å‡†æ¢¯å½¢é€Ÿåº¦æ›²çº¿
4. è®¡ç®—å„é˜¶æ®µæ—¶é—´: t_accel, t_const, t_decel
5. æ€»æ—¶é—´: t_total = t_accel + t_const + t_decel
```

### 2.2 ä½ç½®è®¡ç®—å‡½æ•°
```c
float trapezoid_interpolate(interpolator_t* interp, float progress);
```

**ç®—æ³•é€»è¾‘**ï¼š
```
é˜¶æ®µ1 (åŠ é€Ÿ): 0 â‰¤ t < t_accel
  v(t) = a Ã— t
  s(t) = 0.5 Ã— a Ã— tÂ²
  
é˜¶æ®µ2 (åŒ€é€Ÿ): t_accel â‰¤ t < (t_accel + t_const)
  v(t) = v_max
  s(t) = s_accel + v_max Ã— (t - t_accel)
  
é˜¶æ®µ3 (å‡é€Ÿ): (t_accel + t_const) â‰¤ t < t_total
  v(t) = v_max - d Ã— (t - t_accel - t_const)
  s(t) = s_accel + s_const + v_max Ã— t' - 0.5 Ã— d Ã— t'Â²
```

---

## ğŸ›¤ï¸ é˜¶æ®µä¸‰ï¼šå¤šç‚¹è½¨è¿¹è§„åˆ’

### 3.1 è½¨è¿¹é˜Ÿåˆ—ç®¡ç†
```c
// åˆå§‹åŒ–è½¨è¿¹é˜Ÿåˆ—
void trajectory_init(trajectory_queue_t* traj);

// æ·»åŠ è½¨è¿¹ç‚¹
bool trajectory_add_point(trajectory_queue_t* traj, 
                         float position, 
                         motion_params_t params,
                         uint32_t dwell_time_ms);

// æ¸…ç©ºè½¨è¿¹
void trajectory_clear(trajectory_queue_t* traj);

// å¼€å§‹æ‰§è¡Œè½¨è¿¹
bool trajectory_start(trajectory_queue_t* traj, bool loop);

// åœæ­¢æ‰§è¡Œ
void trajectory_stop(trajectory_queue_t* traj);
```

### 3.2 è½¨è¿¹æ‰§è¡Œé€»è¾‘
```
1. ä»ç‚¹Aåˆ°ç‚¹B
2. åˆ°è¾¾ç‚¹Båï¼Œåœç•™dwell_time_ms
3. è‡ªåŠ¨å¼€å§‹ä»ç‚¹Båˆ°ç‚¹C
4. é‡å¤ç›´åˆ°æœ€åä¸€ä¸ªç‚¹
5. å¦‚æœloop=trueï¼Œå›åˆ°ç¬¬ä¸€ä¸ªç‚¹ç»§ç»­
```

### 3.3 å¤šè½´åè°ƒ
```c
// 18ä¸ªè½´åŒæ—¶æ‰§è¡Œå„è‡ªçš„è½¨è¿¹
typedef struct {
    trajectory_queue_t trajectories[SERVO_COUNT];
    bool sync_mode;  // æ˜¯å¦åŒæ­¥æ¨¡å¼
} multi_axis_trajectory_t;
```

---

## ğŸ“¡ é˜¶æ®µå››ï¼šé€šä¿¡åè®®æ‰©å±•

### 4.1 æ–°å¢å‘½ä»¤

#### å‘½ä»¤1ï¼šæ¢¯å½¢é€Ÿåº¦è¿åŠ¨
```c
#define CMD_MOVE_TRAPEZOID 0x21

// æ•°æ®æ ¼å¼
struct {
    uint8_t servo_id;
    int16_t target_angle;     // ç›®æ ‡è§’åº¦ Ã— 100
    uint16_t max_velocity;    // æœ€å¤§é€Ÿåº¦ Ã— 10 (åº¦/ç§’)
    uint16_t acceleration;    // åŠ é€Ÿåº¦ Ã— 10 (åº¦/ç§’Â²)
    uint16_t deceleration;    // å‡é€Ÿåº¦ Ã— 10 (åº¦/ç§’Â²)
}
```

#### å‘½ä»¤2ï¼šæ·»åŠ è½¨è¿¹ç‚¹
```c
#define CMD_TRAJECTORY_ADD_POINT 0x22

struct {
    uint8_t servo_id;
    int16_t position;         // ä½ç½® Ã— 100
    uint16_t max_velocity;    // é€Ÿåº¦ Ã— 10
    uint16_t acceleration;    // åŠ é€Ÿåº¦ Ã— 10
    uint16_t deceleration;    // å‡é€Ÿåº¦ Ã— 10
    uint16_t dwell_time_ms;   // åœç•™æ—¶é—´
}
```

#### å‘½ä»¤3ï¼šè½¨è¿¹æ§åˆ¶
```c
#define CMD_TRAJECTORY_START 0x23  // å¼€å§‹æ‰§è¡Œ
#define CMD_TRAJECTORY_STOP  0x24  // åœæ­¢æ‰§è¡Œ
#define CMD_TRAJECTORY_CLEAR 0x25  // æ¸…ç©ºè½¨è¿¹
```

### 4.2 åè®®ä¿®æ”¹
- æ‰©å±•`protocol.h`ä¸­çš„å‘½ä»¤å®šä¹‰
- æ›´æ–°`commands.c`ä¸­çš„å‘½ä»¤å¤„ç†å‡½æ•°
- ä¿æŒå‘åå…¼å®¹ï¼ˆåŸæœ‰CMD_MOVE_SINGLEç»§ç»­æ”¯æŒï¼‰

---

## ğŸ–¥ï¸ é˜¶æ®µäº”ï¼šä¸Šä½æœºUIæ‰©å±•

### 5.1 é€Ÿåº¦æ§åˆ¶UI
```
æ¯ä¸ªèˆµæœºè½¨é“å¢åŠ æ§ä»¶ï¼š
[é€Ÿåº¦: 30 Â°/s] [åŠ é€Ÿåº¦: 60 Â°/sÂ²]
```

### 5.2 è½¨è¿¹ç¼–è¾‘å™¨
```
æ–°å¢çª—å£ï¼šè½¨è¿¹ç¼–è¾‘å™¨
- è¡¨æ ¼æ˜¾ç¤ºè½¨è¿¹ç‚¹åˆ—è¡¨
- æ·»åŠ /åˆ é™¤/ç¼–è¾‘ç‚¹
- é¢„è§ˆè½¨è¿¹æ›²çº¿
- æ‰§è¡Œ/åœæ­¢/å¾ªç¯æ§åˆ¶
```

### 5.3 Pythonå®ç°
```python
# serial_comm.py æ–°å¢æ–¹æ³•
def move_trapezoid(self, servo_id, angle, velocity, accel):
    """æ¢¯å½¢é€Ÿåº¦è¿åŠ¨"""
    
def trajectory_add_point(self, servo_id, position, velocity, accel, dwell):
    """æ·»åŠ è½¨è¿¹ç‚¹"""
    
def trajectory_start(self, servo_id, loop=False):
    """å¼€å§‹è½¨è¿¹"""
```

---

## ğŸ§ª é˜¶æ®µå…­ï¼šæµ‹è¯•è®¡åˆ’

### 6.1 å•å…ƒæµ‹è¯•
- [ ] æ¢¯å½¢é€Ÿåº¦è§„åˆ’è®¡ç®—æ­£ç¡®æ€§
- [ ] è½¨è¿¹é˜Ÿåˆ—æ·»åŠ /åˆ é™¤/æ¸…ç©º
- [ ] è¾¹ç•Œæ¡ä»¶æµ‹è¯•ï¼ˆ0ç‚¹ã€1ç‚¹ã€50ç‚¹ï¼‰

### 6.2 åŠŸèƒ½æµ‹è¯•
- [ ] å•è½´æ¢¯å½¢é€Ÿåº¦è¿åŠ¨
- [ ] å¤šè½´åè°ƒè¿åŠ¨
- [ ] å•ç‚¹è½¨è¿¹ï¼ˆé€€åŒ–ä¸ºç‚¹åˆ°ç‚¹ï¼‰
- [ ] å¤šç‚¹è½¨è¿¹ï¼ˆ2ç‚¹ã€10ç‚¹ã€50ç‚¹ï¼‰
- [ ] å¾ªç¯è½¨è¿¹

### 6.3 æ€§èƒ½æµ‹è¯•
- [ ] CPUå ç”¨ç‡ < 5%
- [ ] å†…å­˜å ç”¨æ£€æŸ¥
- [ ] 20msæ’å€¼å‘¨æœŸç¨³å®šæ€§

---

## ğŸ“… å®æ–½æ—¶é—´è¡¨

| é˜¶æ®µ | ä»»åŠ¡ | é¢„è®¡æ—¶é—´ | çŠ¶æ€ |
|------|------|---------|------|
| Phase 1 | æ•°æ®ç»“æ„è®¾è®¡ | 1å°æ—¶ | â³ å¾…å¼€å§‹ |
| Phase 2 | æ¢¯å½¢é€Ÿåº¦ç®—æ³• | 2-3å°æ—¶ | â³ å¾…å¼€å§‹ |
| Phase 3 | å¤šç‚¹è½¨è¿¹å®ç° | 2-3å°æ—¶ | â³ å¾…å¼€å§‹ |
| Phase 4 | é€šä¿¡åè®®æ‰©å±• | 1-2å°æ—¶ | â³ å¾…å¼€å§‹ |
| Phase 5 | ä¸Šä½æœºUI | 2-3å°æ—¶ | â³ å¾…å¼€å§‹ |
| Phase 6 | æµ‹è¯•å’Œä¼˜åŒ– | 2å°æ—¶ | â³ å¾…å¼€å§‹ |
| **æ€»è®¡** | | **10-14å°æ—¶** | |

---

## ğŸ”§ æŠ€æœ¯è¦ç‚¹

### å†…å­˜ä¼˜åŒ–
- è½¨è¿¹é˜Ÿåˆ—æŒ‰éœ€åˆ†é…
- æœªä½¿ç”¨è½¨è¿¹åŠŸèƒ½æ—¶é›¶å¼€é”€

### å®æ—¶æ€§ä¿è¯
- æ‰€æœ‰è®¡ç®—åœ¨20msæ’å€¼å‘¨æœŸå†…å®Œæˆ
- å…³é”®è·¯å¾„ä¼˜åŒ–

### å®‰å…¨æ€§
- é€Ÿåº¦/åŠ é€Ÿåº¦é™åˆ¶æ£€æŸ¥
- ä½ç½®è¾¹ç•Œæ£€æŸ¥ï¼ˆ0-180åº¦ï¼‰
- è¿åŠ¨å¹³æ»‘è¿‡æ¸¡ï¼Œé˜²æ­¢çªå˜

---

## âœ… å®Œæˆæ ‡å‡†

1. âœ… æ¢¯å½¢é€Ÿåº¦æ›²çº¿è¿è¡Œæ­£å¸¸
2. âœ… æ”¯æŒ50ç‚¹è½¨è¿¹
3. âœ… ä¸Šä½æœºUIå®Œæ•´å¯ç”¨
4. âœ… å…¨éƒ¨æµ‹è¯•é€šè¿‡
5. âœ… æ–‡æ¡£å®Œå–„

---

## ğŸ“ å¤‡æ³¨

- ä¿æŒå‘åå…¼å®¹æ€§
- ä»£ç éµå¾ªç°æœ‰é£æ ¼
- å……åˆ†çš„æ³¨é‡Šå’Œæ–‡æ¡£
- åˆ†æ­¥æäº¤ï¼Œä¾¿äºå›æ»š

