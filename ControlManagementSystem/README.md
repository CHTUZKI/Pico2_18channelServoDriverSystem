# 18通道舵机时间轴控制上位机

基于PyQt5开发的可视化舵机控制软件，支持Raspberry Pi Pico 2舵机控制器。

## 功能特性

- 🎯 **可视化时间轴编辑**：类似视频编辑软件的时间轴界面，直观易用
- 🔧 **18通道舵机控制**：支持18个舵机（编号0-17）独立控制
- 📐 **角度精确控制**：0-180度角度控制，精度0.1度
- ⏱️ **时间同步**：多轴同步运动，精确的时间控制
- 🔄 **循环/单次模式**：每个舵机轨道可独立设置循环或单次执行
- 📝 **命令序列生成**：自动生成舵机控制命令序列
- 🔌 **串口通信**：支持USB串口连接Pico 2开发板
- 📊 **实时监控**：实时显示通信状态和日志
- 💾 **项目保存**：支持项目文件保存和加载
- 📋 **日志系统**：完整的操作日志记录

## 系统要求

- Python 3.7+
- PyQt5 5.15.0+
- pyserial 3.5+
- Windows/Linux/macOS

## 安装说明

1. 克隆或下载项目到本地
2. 安装依赖包：
   ```bash
   pip install -r requirements.txt
   ```
3. 运行程序：
   ```bash
   python main.py
   ```

## 硬件配置

### Raspberry Pi Pico 2配置
- 主控：Raspberry Pi Pico 2 (RP2350)
- 固件：自定义QP/C舵机控制固件
- 连接方式：USB串口 (115200波特率)
- 舵机数量：18个（编号0-17）

### 舵机配置
- 支持标准PWM舵机（180度位置舵机）
- 支持360度连续旋转舵机
- 角度范围：0-180度
- 控制精度：±0.5度

## 通信协议

### 帧格式
```
[0xFF][0xFE][ID][CMD][LEN][DATA...][CRC_H][CRC_L]
```

字段说明：
- **帧头**: 0xFF 0xFE (固定)
- **ID**: 设备ID (0x00=广播)
- **CMD**: 命令字节
- **LEN**: 数据长度
- **DATA**: 数据内容
- **CRC**: CRC-16 CCITT校验

### 命令集

| 命令 | 代码 | 功能 | 数据格式 |
|------|------|------|---------|
| MOVE_SINGLE | 0x01 | 单轴控制 | [舵机ID(0-17)][角度高][角度低][时间高][时间低] |
| MOVE_ALL | 0x03 | 18轴同步 | [角度0高][角度0低]...[角度17高][角度17低][时间高][时间低] |
| GET_SINGLE | 0x10 | 查询单轴 | [舵机ID(0-17)] |
| GET_ALL | 0x11 | 查询全轴 | - |
| ENABLE | 0x20 | 使能舵机 | [舵机ID(0-17)] (0xFF=全部) |
| DISABLE | 0x21 | 禁用舵机 | [舵机ID(0-17)] (0xFF=全部) |
| SAVE_FLASH | 0x30 | 保存位置 | - |
| LOAD_FLASH | 0x31 | 加载参数 | - |
| RESET_FACTORY | 0x32 | 恢复出厂 | - |
| PING | 0xFE | 心跳检测 | - |
| ESTOP | 0xFF | 紧急停止 | - |

**注意**：
- 角度数据：实际角度×100（例如90.5度 = 9050）
- 时间单位：毫秒（例如1000 = 1秒）

## 使用说明

### 1. 连接硬件
1. 将Pico 2开发板通过USB连接到电脑
2. 点击工具栏"连接"按钮
3. 选择正确的串口并连接

### 2. 创建时间轴程序
1. 从左侧部件面板拖拽部件到时间轴
2. 支持的部件类型：
   - **正转**：舵机转动到指定角度（0-180度）
   - **反转**：舵机转动到指定角度（用于对称运动）
   - **延时**：暂停指定时间
   - **归零**：将舵机归零到90度中位
   - **停止**：停止舵机运动

3. 调整部件参数：
   - 右键点击部件选择"编辑参数"
   - 设置角度（0-180度）
   - 设置运动时间（100-10000毫秒）

4. 设置循环模式：
   - 在每条轨道右侧选择"单次"或"循环"

### 3. 运行程序
1. 点击"生成命令序列"预览生成的命令
2. 点击"运行"开始执行程序
3. 使用"停止"按钮可紧急停止所有舵机

### 4. 项目管理
- **新建**：创建新的时间轴项目
- **打开**：加载已保存的项目文件
- **保存**：保存当前项目
- **导出命令序列**：将时间轴导出为文本文件

## 界面说明

### 主界面布局
- **左侧**：部件面板，包含可拖拽的部件
- **中间**：时间轴工作区，18条舵机轨道（舵机0-17）
- **右侧**：命令序列预览窗口和通信日志
- **底部**：应用日志窗口

### 时间轴操作
- **拖拽**：从部件面板拖拽部件到轨道
- **移动**：拖拽部件调整位置
- **调整大小**：拖拽部件边缘调整时长
- **编辑**：右键点击部件编辑参数
- **删除**：选中部件后按Delete键

### 工具栏功能
- **连接/断开**：串口连接控制
- **运行/停止**：程序执行控制
- **生成命令序列**：预览生成的命令
- **输出运动逻辑表**：导出运动表格

## 命令序列示例

```
; 18通道舵机时间轴控制程序
; 由舵机控制上位机自动生成

; 协议: 自定义帧格式 + CRC-16校验
; 帧格式: [0xFF][0xFE][ID][CMD][LEN][DATA][CRC_H][CRC_L]

; === 命令 1 ===
; 时间: 0.00s
; 类型: 运动命令
; 速度: 1000ms
;   舵机0: 90.0°
;   舵机1: 45.0°
;   舵机2: 120.0°
CMD: MOVE_ALL

; === 命令 2 ===
; 时间: 1.50s
; 类型: 延时
; 时长: 0.50s
CMD: DELAY 0.50s

; === 命令 3 ===
; 时间: 2.00s
; 类型: 运动命令
; 速度: 2000ms
;   舵机0: 180.0°
;   舵机1: 0.0°
CMD: MOVE_ALL

; 程序结束
```

## 故障排除

### 串口连接问题
- 检查USB连接
- 确认串口驱动已安装
- 尝试其他波特率
- 检查串口是否被其他程序占用

### 舵机不运动
- 检查舵机电源供应（6V独立供电）
- 确认舵机已使能
- 检查角度设置是否合理
- 查看通信日志的错误信息

### 程序崩溃
- 查看日志文件：`logs/motor_control_*.log`
- 检查Python和PyQt5版本兼容性
- 重新安装依赖包

## 开发说明

### 项目结构
```
ControlManagementSystem/
├── main.py                    # 程序入口
├── ui/                        # 用户界面模块
│   ├── main_window.py        # 主窗口
│   ├── timeline_widget.py    # 时间轴组件
│   ├── component_palette.py  # 部件面板
│   ├── motor_track.py        # 舵机轨道
│   └── dialogs.py            # 对话框
├── core/                      # 核心功能模块
│   ├── servo_commander.py    # 命令生成器
│   ├── serial_comm.py        # 串口通信
│   ├── project_manager.py    # 项目管理
│   ├── config_manager.py     # 配置管理
│   └── logger.py             # 日志系统
├── models/                    # 数据模型
│   ├── component.py          # 部件模型
│   └── timeline_data.py      # 时间轴数据
└── logs/                      # 日志文件
```

### 扩展开发
- 添加新的部件类型：修改`models/component.py`
- 自定义命令生成：修改`core/servo_commander.py`
- 添加新的通信协议：修改`core/serial_comm.py`

## 许可证

本项目采用MIT许可证，详见LICENSE文件。

## 联系方式

如有问题或建议，请通过以下方式联系：
- 提交Issue
- 发送邮件
- 项目讨论区

---

**注意**：
- 舵机电源必须独立供电（推荐6V/3A以上）
- 使用前请确保硬件连接正确
- 建议先在安全环境下测试

**版本**: v1.0.0 (18通道舵机控制版本)
**更新日期**: 2025-10-25
